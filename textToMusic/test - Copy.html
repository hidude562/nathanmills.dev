<!DOCTYPE html>
<link rel="stylesheet" href="../style.css">
<link rel="stylesheet" href="../niceLookingTable.css">

<html lang="en">
<head>
	<title>nathanmills.dev - textToMusic</title>
	<!-- Include -->
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0"></meta>
	<meta name="description" content="Easily classify text using magic">
	
	<link rel="icon" href="../icon.png">
	<object type="text/html" data="../banner.html" width=100% style="height: 200px"></object>
</head>
<body>

<div class="main_layer">
<div class="nav">
	<!-- Include the nav table -->
	<object type="text/html" data="../nav.html" height=100%></object>
</div>

<div class="page_dis">
<h1>textToMusic</h1>

<p>This is kind of cool use case of the "EZclassifier", it takes in text and finds an fitting song by legendary composer Kevin Macleod for background music.</p>

<br>

<textarea type="text" id="textInput" rows="10" cols="70" style="width: calc(100% - 15px)">text goes here</textarea>
<br>
<button onclick="run()">Run</button>

<br>

<h2>Top choices:</h2>
<h2 id="Top"></h2>
<div id="other"></div>

</div>
</div>

<object type="text/html" data="../footer2023.html" width=100%></object>
</body>
</html>

<script>
	function addNewRow() {
		var newRow = document.getElementById("dataset").insertRow(1);
		
		var cell1 = newRow.insertCell(0);
		cell1.setAttribute("contenteditable", true)
		cell1.setAttribute("id", "text")
		var cell2 = newRow.insertCell(1)
		cell2.setAttribute("contenteditable", true);
		cell2.setAttribute("id", "output")
	}
	function deleteRow() {
		document.getElementById("dataset").deleteRow(1);
	}
</script>

<script>
	function newDatasetClassifier() {
		var rows = document.getElementById("dataset").rows
		dataPoints = []
		
		for(var row of rows) {
			let text = row.children[0].textContent;
			let out = row.children[1].textContent;
			dataPoints.push(new DataPoint(text, out))
			console.log(out);
		}
	}
	
	function saveClassifier() {
		console.log("Saving")
		document.getElementById("saveButton").href = "data:text/plain," + JSON.stringify(dataPoints)
	}
	
	
	function loadClassifier() {
		console.log("LOADING")
		dataPoints = [{"output":"https://www.youtube.com/embed/twdNHG3NKQU","text":"wholesome carefree relaxing"},{"output":"https://www.youtube.com/embed/kRGPOTkQpus","text":"conquest prospering nation"},{"output":"https://www.youtube.com/embed/co4NWTsJdfI","text":"war military dramatic"},{"output":"https://www.youtube.com/embed/PVZbjORqt6A","text":"mysterious unresolved spooky"},{"output":"https://www.youtube.com/embed/CJu63gMNhCE","text":"forecast elevator relaxing"},{"output":"https://www.youtube.com/embed/yvMxSz7dIjI","text":"dystopian thinking contemplating"},{"output":"https://www.youtube.com/embed/VlKcRgGkPBI","text":"shocked dramatic anger"},{"output":"https://www.youtube.com/embed/lZDdOiaN_TA","text":"tyrannical regime dramatic"},{"output":"https://www.youtube.com/embed/O4D3fMpDNCU","text":"adventurous voyage hero"},{"output":"https://www.youtube.com/embed/VDzp2TnoFG0","text":"plotting planning dramatic"},{"output":"https://www.youtube.com/embed/f5Tatbs1WxY","text":"trivial fun quirky"},{"output":"https://www.youtube.com/embed/i-Taa4CS_MQ","text":"fun party people"},{"output":"https://www.youtube.com/embed/c4EkfWFqKzE","text":"conflict final scary"},{"output":"https://www.youtube.com/embed/xbuzzXaG0VQ","text":"dramatic final scary"},{"output":"https://www.youtube.com/embed/C6hyc4V8To0","text":"sneaky complex scary"},{"output":"https://www.youtube.com/embed/sXDPngaPDuU","text":"mischievous happy goofy"},{"output":"https://www.youtube.com/embed/VKGKAifd8B0","text":"wholesome outside happy"},{"output":"https://www.youtube.com/embed/hh61GmaTmjc","text":"industrious bustling dystopian"},{"output":"https://www.youtube.com/embed/zvPYgXf79LY","text":"conflict scary sneaky"},{"output":"https://www.youtube.com/embed/QrqjLoPbnyY","text":"scheming contemplating sneaky"},{"output":"https://www.youtube.com/embed/XosfAzrpjWQ","text":"silly quirky goofy"},{"output":"https://www.youtube.com/embed/_Mcn4OyNAg4","text":"medieval outside villagers"},{"output":"https://www.youtube.com/embed/wNjJiZk7H28","text":"relaxing happy serene"},{"output":"Cipher","text":"won happy completing"},{"output":"https://www.youtube.com/embed/y4zXHvaQ7Ng","text":"thinking mischievous sinister"},{"output":"https://www.youtube.com/embed/LrM_Y39Gmhk","text":"silly obnoxious funny"},{"output":"https://www.youtube.com/embed/XhCARou6mRI","text":"silly goofy mindless"}]
	}
	
	function run() {
		let inputText = document.getElementById('textInput').value;
		quereyNeuralOutputs(inputText)
		console.log(inputText)
	}
</script>

<script>
	class DataPoint {
		constructor(text, output, neuralPoints=null) {
			this.output = output
			this.text = text
		}
	}
</script>

<script>
	var API_KEY = "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";
	var outputsThisText;
	var dataPoints = []
	
	
	async function query(data) {
		console.log(JSON.stringify(data))
		const response = await fetch(
			"https://api-inference.huggingface.co/models/sentence-transformers/all-MiniLM-L6-v2",
			{
				headers: { Authorization: "Bearer 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" },
				method: "POST",
				body: JSON.stringify(data),
			}
		);
		const result = await response.json();
		return result;
	}
	
	function eToTheXOfArray(data) {
		for(var i = 0; i < data.length; i++) {
			data[i] = Math.pow(Math.E, data[i] * 10)
		}
		return data
	}
	
	function getDataPointsAsInput() {
		newDat = []
		for(var point of dataPoints) {
			newDat.push(point.text)
		}
		return newDat
	}
	
	function compareNums(a, b) {
		if(a > b) {
			return -1
		} else if(b > a) {
			return 1
		}
		
		return 0
	}
	
	function quereyNeuralOutputs(input) {
		loadClassifier()
		
		let output;
		query({"inputs": {"source_sentence": input, "sentences": getDataPointsAsInput()}}).then((response) => {
			output = eToTheXOfArray(response)
			let highestVal = -1
			let highestOutput = "Nothing??"
			
			let outputs = []
			let outputValues = []
			
			let totalVal = 0;
			for(let i = 0; i < output.length; i++) {
				arrDiff = output[i]
				console.log(output[i]);
				totalVal += arrDiff
				if(arrDiff > highestVal) {
					highestVal = arrDiff
					highestOutput = dataPoints[i].output
				}
				outputValues.push(arrDiff)
				outputs.push(dataPoints[i].output)
			}
			
			// https://stackoverflow.com/questions/11499268/sort-two-arrays-the-same-way
			indices = Array.from(outputValues.keys())
                     .sort( (a,b) => compareNums(outputValues[a], outputValues[b]) )
			console.log(indices)
                     
			outputValues = indices.map(i => outputValues[i])
			outputs = indices.map(i => outputs[i])
			
			document.getElementById("Top").innerHTML = "<iframe width='420' height='315' fetchpriority='high' src='" + highestOutput + "'></iframe>" + "<p>" + Math.round(highestVal / totalVal * 10000) / 100 + "%</p><br>"
			
			document.getElementById("other").innerHTML = "<h3>Other choices:</h3>"
			for(let i = 1; i < outputs.length; i++) {
				document.getElementById("other").innerHTML += "<iframe width='320' fetchpriority='low' height='200' src='" + outputs[i] + "'></iframe>" + "<p>" + Math.round(outputValues[i] / totalVal * 10000) / 100 + "%</p><br>"
			}
		});
	}
</script>